;jQuery( function() {
    // 停止
    $("body").on('click','[data-stopPropagation]',function (e) {
        e.stopPropagation();
    });

    // 滚动条
    if($('.lyear-scroll')[0]) {
        $('.lyear-scroll').each(function(){
            new PerfectScrollbar(this, {
                swipeEasing: false,
                suppressScrollX: true
            });
        });
    }

    // 侧边栏
    $(document).on('click', '.lyear-aside-toggler', function() {
        $('.lyear-layout-sidebar').toggleClass('lyear-aside-open');
        $("body").toggleClass('lyear-layout-sidebar-close');

        if ($('.lyear-mask-modal').length == 0) {
            $('<div class="lyear-mask-modal"></div>').prependTo('body');
        } else {
            $( '.lyear-mask-modal' ).remove();
        }
    });

    // 遮罩层
    $(document).on('click', '.lyear-mask-modal', function() {
        $( this ).remove();
        $('.lyear-layout-sidebar').toggleClass('lyear-aside-open');
        $('body').toggleClass('lyear-layout-sidebar-close');
    });

    // 侧边栏导航
    $(document).on('click', '.nav-item-has-subnav > a', function() {
        $subnavToggle = jQuery( this );
        $navHasSubnav = $subnavToggle.parent();
        $topHasSubNav = $subnavToggle.parents('.nav-item-has-subnav').last();
        $subnav       = $navHasSubnav.find('.nav-subnav').first();
        $viSubHeight  = $navHasSubnav.siblings().find('.nav-subnav:visible').outerHeight();
        $scrollBox    = $('.lyear-layout-sidebar-info');
        $navHasSubnav.siblings().find('.nav-subnav:visible').slideUp(500).parent().removeClass('open');
        $subnav.slideToggle( 300, function() {
            $navHasSubnav.toggleClass( 'open' );

            // 新增滚动条处理
            var scrollHeight  = 0;
            pervTotal     = $topHasSubNav.prevAll().length,
                boxHeight     = $scrollBox.outerHeight(),
                innerHeight   = $('.sidebar-main').outerHeight(),
                thisScroll    = $scrollBox.scrollTop(),
                thisSubHeight = $(this).outerHeight(),
                footHeight    = 121;

            if (footHeight + innerHeight - boxHeight >= (pervTotal * 48)) {
                scrollHeight = pervTotal * 48;
            }
            if ($subnavToggle.parents('.nav-item-has-subnav').length == 1) {
                $scrollBox.animate({scrollTop: scrollHeight}, 300);
            } else {
                // 子菜单操作
                if (typeof($viSubHeight) != 'undefined' && $viSubHeight != null) {
                    scrollHeight = thisScroll + thisSubHeight - $viSubHeight;
                    $scrollBox.animate({scrollTop: scrollHeight}, 300);
                } else {
                    if ((thisScroll + boxHeight - $scrollBox[0].scrollHeight) == 0) {
                        scrollHeight = thisScroll - thisSubHeight;
                        $scrollBox.animate({scrollTop: scrollHeight}, 300);
                    }
                }
            }
        });
    });

    // 读取cookie中的主题设置
    var the_logo_bg    = $.cookie('the_logo_bg'),
        the_header_bg  = $.cookie('the_header_bg'),
        the_sidebar_bg = $.cookie('the_sidebar_bg');

    if (the_logo_bg) $('body').attr('data-logobg', the_logo_bg);
    if (the_header_bg) $('body').attr('data-headerbg', the_header_bg);
    if (the_sidebar_bg) $('body').attr('data-sidebarbg', the_sidebar_bg);

    // 处理主题配色下拉选中
    $(".dropdown-skin :radio").each(function(){
        var $this = $(this),
            radioName = $this.attr('name');
        switch (radioName) {
            case 'logo_bg':
                $this.val() == the_logo_bg && $this.prop("checked", true);
                break;
            case 'header_bg':
                $this.val() == the_header_bg && $this.prop("checked", true);
                break;
            case 'sidebar_bg':
                $this.val() == the_sidebar_bg && $this.prop("checked", true);
        }
    });

    // 设置主题配色
    setTheme = function(input_name, data_name) {
        $("input[name='"+input_name+"']").click(function(){
            $('body').attr(data_name, $(this).val());
            $.cookie('the_'+input_name, $(this).val());
        });
    }
    setTheme('sidebar_bg', 'data-sidebarbg');
    setTheme('logo_bg', 'data-logobg');
    setTheme('header_bg', 'data-headerbg');

    // 选项卡
    $('#iframe-content').multitabs({
        iframe : true,
        refresh : 'no',  // iframe中页面是否刷新，'no'：'从不刷新'，'nav'：'点击菜单刷新'，'all'：'菜单和tab点击都刷新'
        nav: {
            backgroundColor: '#ffffff',
            maxTabs : 35, // 选项卡最大值
        },
        init : [{
            type : 'main',
            title : '首页',
            url : 'main.html'
        }]
    });

    $(document).on('click', '.nav-item .multitabs', function() {
        $('.nav-item').removeClass('active');
        $('.nav-subnav li').removeClass('active');
        $(this).parent('li').addClass('active');
        $(this).parents('.nav-item-has-subnav').addClass('open').first().addClass('active');
    });


    /**
     * 菜单
     * @param data 菜单JSON数据
     *        id 菜单唯一ID
     *        name 菜单名称
     *        url 菜单链接地址
     *        icon 图标
     *        pid  父级ID
     *        is_out 是否外链0否|1是,外链a标签没有class='multitabs'
     *        is_home 是否首页
     */
    var setSidebar = function(data){
        if (data.length == 0) return false;
        var treeObj = treeData(data, 'id', 'pid', 'children');
        html = createMenu(treeObj, true);
        $('.sidebar-main').append(html);

        // 刷新重新点击被点击过的页面
        setTimeout(function(){
            var rootPath = function(){
                var curWwwPath = window.document.location.href;
                var pathName = window.document.location.pathname;
                var pos = curWwwPath.indexOf(pathName);
                var localhostPaht = curWwwPath.substring(0, pos);
                var projectName = pathName.substring(0, pathName.substr(1).indexOf('/') + 1);
                return (localhostPaht+projectName);
            }();
            $('.multitabs').click(function(){
                var stateObject = {};
                var title = this.innerHTML;
                var href = this.href.replace('/#', '');
                href = href.replace(rootPath, rootPath+'/#');
                if(href != 'javascript:void(0)'){
                    window.history.pushState(stateObject, title, href);
                }else{
                    var href = $(this).data("url");
                    if(href){
                        window.history.pushState(stateObject, this.outerText, rootPath+'/#/'+href);
                    }
                }
            });

            if(window.location.hash){
                var ismatch = false;
                $('.multitabs').each(function(){
                    var href = '#'+this.href.replace(rootPath, '');
                    var locationHashs = window.location.hash.split('?');
                    window.accessQuery = locationHashs[1] ? locationHashs[1] : '';
                    if(locationHashs[0] == href){
                        ismatch = true;
                        $(this).click();
                    }
                });
                if(ismatch == false){
                    $('#user-menus').find('a').each(function(){
                        var dataUrl = $(this).data('url');
                        if(dataUrl){
                            var href = dataUrl.replace(window.document.location.origin, '#');
                            // 记录一下是否被点击，如果没有检查一下头右部菜单
                            if(window.location.hash.replace('#/', '') == href){
                                ismatch = true;
                                $(this).click();
                            }
                        }
                    });
                }
            }

            function tabChange(){
                var obj = $('.mt-nav .nav-item .active');
                var url = obj.data('url');
                var stateObject = {};
                var title = obj.innerHTML;
                var href = rootPath+'/#/'+url;
                window.history.pushState(stateObject, title, href);

            }
            $('.mt-nav-panel').click(function(){
                setTimeout(function(){
                    tabChange();
                }, 300);
            });

        },100);


    }

    var createMenu = function (data, is_frist) {
        var menu_body = is_frist ? '<ul class="nav-drawer">' : '<ul class="nav nav-subnav">';

        for(var i = 0; i < data.length; i++){
            iframe_class = data[i].is_out == 1 ? '' : 'class="multitabs"';
            icon_div     = data[i].pid == 0 ? '<i class="' + data[i].icon + '"></i>' : '';
            selected     = (data[i].pid == 0) && (data[i].is_home == 1) ? 'active' : '';
            menuName     = data[i].pid == 0 ? '<span>' + data[i].name + '</span>' : data[i].name;
            if (data[i].children && data[i].children.length > 0) {
                menu_body += '<li class="nav-item nav-item-has-subnav"><a href="javascript:void(0)">' + icon_div + menuName + '</a>';
                menu_body += createMenu(data[i].children);
            } else {
                menu_body += '<li class="nav-item ' + selected + '"><a href="' + data[i].url + '" '+ iframe_class +'>' + icon_div + menuName + '</a>';
            }
            menu_body += '</li>';
        }

        menu_body += '</ul>';
        return menu_body;
    };

    /**
     * @author CSDN 蔚莱先森
     * @param source json数据源
     * @param id 主键ID
     * @param parendId 父级ID名称
     * @param children 子级名称
     */
    var treeData = function (source, id, parentId, children){
        let cloneData = (typeof source == 'object') ? source : JSON.parse(source);
        return cloneData.filter(father=>{
            let branchArr = cloneData.filter(child => father[id] == child[parentId]);
            branchArr.length>0 ? father[children] = branchArr : ''
            return father[parentId] == 0
        })
    }
    // 加载菜单
    ready(function(){
        layui.use(['zhanshop'], function(){
            var zhanshop = layui.zhanshop;
            var token = zhanshop.getcookie('token');
            zhanshop.ajax(API_ADDRESS+'/v1/api.doc', 'GET', {}, {"token":token}, function(res){
                try{
                    var json_str = JSON.stringify(res.data.menu);
                    setSidebar(json_str);
                    $('.img-avatar').attr('src', res.data.user.avatar);
                    $('.dropdown-toggle span').eq(0).html(res.data.user.user_name);
                }catch (e) {
                    console.error(e);
                    return zhanshop.alert("页面渲染出错,详见控制台输出", 'danger');
                }

            },function(xhr){
                return zhanshop.alert(xhr.responseJSON.msg ? xhr.responseJSON.msg : xhr.statusText, 'danger');
            });

        });



    });

});