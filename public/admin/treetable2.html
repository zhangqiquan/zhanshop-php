<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=0.75, maximum-scale=1.0, user-scalable=yes, user-scalable=0, minimal-ui">
    <link href="./css/bootstrap.min.css" rel="stylesheet">
    <link href="./css/materialdesignicons.min.css" rel="stylesheet">
    <link href="./css/style.min.css" rel="stylesheet">
    <link rel="stylesheet" type="text/css" href="js/layer/css/layui.css">
    <meta http-equiv="pragma" content="no-cache">
    <meta http-equiv="cache-control" content="no-cache">
    <meta http-equiv="expires" content="0">
    <script>
        var searchFieldNum = 0;
    </script>
</head>

<body>
<div class="container-fluid p-t-15" id="view">

    <div class="row">

        <div class="col-lg-12">
            <div class="card">
                <div class="layui-tab layui-tab-brief" lay-filter="docDemoTabBrief">
                    {{#  if(d.tabs.length){ }}
                    <ul class="layui-tab-title">
                        {{#  arr_foreach(d.tabs, function(k1, v1){ }}
                        {{#  if(k1 == 0){ }}
                        <li class="layui-this" onclick="tabsLink(this)" data-where='{{v1.where}}'>{{v1.title}}</li>
                        {{# }else{ }}
                        <li  onclick="tabsLink(this)" data-where='{{v1.where}}'>{{v1.title}}</li>
                        {{#  } }}
                        {{#  }); }}
                    </ul>
                    {{#  } }}

                    <div class="layui-tab-content">

                        <div class="card-toolbar d-flex flex-column flex-md-row">
                            <div class="toolbar-btn-action"> <a style="color: #000;font-size: 18px;opacity: 0.7;line-height: 1.6em;">{{d.title}}</a>
                            </div>
                            <form class="search-bar ml-md-auto" method="post" onsubmit="return laysearch(this);">
                                <div class="input-group ml-md-auto"> <select name="field" id="search-field" class="custom-select" style="max-width: 110px!important;text-align: center;">
                                    {{#  arr_foreach(d.cols, function(k1, v1){ }}
                                    {{#  if(v1.search === true || searchFieldNum == 0){ }}
                                    <option value="{{v1.field}}">{{v1.title}}</option>
                                    {{#  } }}
                                    {{searchFieldNum++}}
                                    {{#  }); }}
                                </select>
                                    <input id="search-val" type="text" class="form-control" style="width: 250px;" name="keyword" placeholder="请输入搜索内容"> <button class="btn btn-outline-success" type="submit">搜索</button>&nbsp;
                                    <button class="btn btn-outline-warning" type="button" onclick="advancedSearch()">高级</button> </div>
                            </form>
                        </div>
                    </div>

                    <table id="laytable" lay-filter="laytable"></table>

                    <script id="left-toolbar" type="text/html">
                        <div class="layui-btn-container layui-btn-group">
                            {{#  arr_foreach(d.head_toolbar, function(k1, v1){ }}
                            {{#  if(v1.event != 'hidden'){ }}
                            <button class="layui-btn layui-btn-primary layui-btn-sm head-event"  data-event="{{v1.event}}" lay-event="header" data-href='{{v1.href}}' data-title="{{v1.title}}" data-page="{{v1.page}}"><i class="layui-icon">{{v1.ico}}</i>{{v1.title}}</button>
                            {{#  } }}
                            {{#  }); }}
                        </div>
                    </script>
                    <!---右击菜单--->
                    <div id="contextmenu" class="inner show" style="height: auto;min-height: 0px;position: absolute;left: 0px;top: 0px;z-index: 999999999999999;background: #f33;display: none;">
                        <ul class="dropdown-menu inner show" style="border: 1px solid #dddddd!important;">
                            {{#  arr_foreach(d.row_toolbar, function(k1, v1){ }}
                            {{#  if(v1.event != 'hidden'){ }}
                            <li><a class="dropdown-item row-event" href="javascript:void(0);" data-event="{{v1.event}}" data-method='{{v1.method}}' data-title="{{v1.title}}" data-page="{{v1.page}}"><i class="layui-icon">{{v1.ico}}</i>&nbsp;&nbsp;<span class="text">{{v1.title}}</span></a></li>
                            {{#  } }}

                            {{#  }); }}
                            <li><a class="dropdown-item row-event" data-event="source" data-event="alert" href="javascript:void(0);" ><i class="layui-icon">&#xe6b2;</i>&nbsp;&nbsp;<span class="text">查看数据源</span></a></li>
                        </ul>
                    </div>

                </div>
            </div>
        </div>

    </div>

</div>
<script type="text/javascript" src="js/layer/layui.js"></script>
<script>
    ready(function() {
        layui.use(['zhanshop', 'zhanshopDataFormat'], function(){
            layui.zhanshop.view(API_ADDRESS + '/v4.0.0/index.table?id=' + layui.zhanshop.getParam('_id'), '#view', function(
                data) {


                var treeTable = layui.treeTable;
                var layer = layui.layer;
                var dropdown = layui.dropdown;

                window.colsData = [{type: 'checkbox'}];
                for(var i in data.cols){
                    if(data.cols[i]['in_list'] !== false){
                        colsData.push({field: data.cols[i]['field'], title: data.cols[i]['title'], width:data.cols[i]['width'], sort: data.cols[i]['sort']});
                    }
                }

                // 渲染
                var inst = treeTable.render({
                    elem: '#laytable',
                    url: API_ADDRESS + '/v4.0.0/index.table?id=' + layui.zhanshop.getParam('_id'), // 此处为静态模拟数据，实际使用时需换成真实接口
                    tree: {

                        // 异步加载子节点
                        async: {
                            enable: true,
                            url: API_ADDRESS + '/v4.0.0/index.table?id=' + layui.zhanshop.getParam('_id'), // 此处为静态模拟数据，实际使用时需换成真实接口
                            where: {"pid":1},
                            method: 'post',
                        },
                        view: {
                            icon: ' ',
                        }
                    },
                    maxHeight: '501px',
                    toolbar: '#TPL-treeTable-demo',
                    cols: [colsData],
                    page: true,
                    parseData: function(res){
                        var data = res.data.list;
                        //data = layui.zhanshopDataFormat.onHandle(data, layui.zhanshopTable.schma);
                        return {
                            "code": res.code, //解析接口状态
                            "msg": res.msg, //解析提示文本
                            "count": res.data.total, //解析数据长度
                            "data": data //解析数据列表
                        };
                    }
                });
                // 表头工具栏工具事件
                treeTable.on("toolbar(laytable)", function (obj) {
                    var config = obj.config;
                    var tableId = config.id;
                    var status = treeTable.checkStatus(tableId);
                    // 获取选中行
                    if (obj.event === "getChecked") {
                        if(!status.data.length) return layer.msg('无选中数据');
                        console.log(status);
                        layer.alert("当前数据选中已经输出到控制台，<br>您可按 F12 从控制台中查看结果。");
                    }
                });
                // 单元格工具事件
                treeTable.on('tool('+ inst.config.id +')', function (obj) {
                    var layEvent = obj.event; // 获得 lay-event 对应的值
                    var trElem = obj.tr;
                    var trData = obj.data;
                    var tableId = obj.config.id;
                    if (layEvent === "detail") {
                        layer.msg("查看操作：" + trData.name);
                    } else if (layEvent === "addChild") {
                        var data = { id: Date.now(), name: "新节点" };
                        var newNode2 = treeTable.addNodes(tableId, {
                            parentIndex: trData["LAY_DATA_INDEX"],
                            index: -1,
                            data: data
                        });
                    } else if (layEvent === "more") {
                        // 下拉菜单
                        dropdown.render({
                            elem: this, // 触发事件的 DOM 对象
                            show: true, // 外部事件触发即显示
                            align: "right", // 右对齐弹出
                            data: [
                                {
                                    title: "修改积分",
                                    id: "edit"
                                },
                                {
                                    title: "删除",
                                    id: "del"
                                }
                            ],
                            click: function (menudata) {
                                if (menudata.id === "del") {
                                    layer.confirm("真的删除行么", function (index) {
                                        obj.del(); // 等效如下
                                        // treeTable.removeNode(tableId, trElem.attr('data-index'))
                                        layer.close(index);
                                    });
                                } else if (menudata.id === "edit") {
                                    layer.prompt({
                                        value: trData.experience,
                                        title: "输入新的积分"
                                    }, function (value, index) {
                                        obj.update({ experience: value }); // 等效如下
                                        // treeTable.updateNode(tableId, trElem.attr('data-index'), {experience: value});
                                        layer.close(index);
                                    });
                                }
                            }
                        });
                    }
                });

            }, 'POST', {"_method":"render"});

        });
    });

</script>
</body>
</html>
